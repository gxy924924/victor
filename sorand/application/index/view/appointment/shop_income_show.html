<!DOCTYPE html>
<html lang="en">
<head>
	{include file="public/sorand/title.html"}

	<!-- date专用 -->
	<link rel="stylesheet" href="/public/date/lib/themes/default.css" id="theme_base">
	<link rel="stylesheet" href="/public/date/lib/themes/default.date.css" id="theme_date">
	<link rel="stylesheet" href="/public/date/lib/themes/default.time.css" id="theme_time">
	<!-- date专用 -->

</head>
	<style>
		.mar{
			color: #ccc;
		}
		.navbar-header .navbar-brand{
			font-size: 28px;
		}
		.col-md-3{
			padding-left: 0;
			padding-right: 5px;
		}
		.col-md-9{
			padding-left: 5px;
			padding-right: 0;
		}
		.row{
			margin-bottom: 5px;
			text-align: center;
		}
		.font-gray{
			color: #666;
		}
		h4{
			margin: 5px;
			font-weight: bold;
			color: #444;
		}
		.posit{
			/*width:70px;*/
		}
		.appo_time{
			/*width:90px;*/
		}
		.reg_time{
			/*width:90px;*/
		}
		.table>tbody>tr>td{
			padding: 5px;
		}
		.table{
			width: 100%;
			margin:0px;
		}
		.col-sm-4{
			margin-bottom: 10px;
		}

		.search_btn{
			width:100px;
			margin-right: 20px;
		}
		.page-box{
			margin-top: 10px;

		}
		.panel{
			margin-bottom:0;
		}
		.pagination{
			margin:10px;
		}
		tr{
			height: 55px;
		}
		.nav{
			margin-top: 0px;
			padding-top: 0;
		}
		th>.nav>li>a{
			margin: 0;
			padding: 0;
			color:#333;
		}
		.caret{
			color:#559;
		}

	</style>
<body>
	
	{include file="public/sorand/header.html"}

	<div class="container">
			
		<div class="panel panel-default text-center">
			<div class="panel-heading panel-title"  href="#collapseSearch" data-toggle="collapse" >
				<h4  >搜索▽</h4>
			</div>
			<div class="panel-body panel-collapse collapse <?php if(empty($_GET['add_time_start'])&&empty($_GET['add_time_stop'])){ echo 'in';} ?>" id="collapseSearch">
				<form action="{:url('index/appointment/shop_income_show')}" method="get">
					<div class="col-sm-4">
						<div class="input-group">
							<span class="input-group-addon">登记(起)</span>
							<input type="text" name="add_time_start"  class="form-control form-control js__datepicker" value="" placeholder="输入时间" value="" id="add_time_start">
						</div>
					</div>
					<div class="col-sm-4">
						<div class="input-group">
							<span class="input-group-addon">登记(止)</span>
							<input type="text" name="add_time_stop"  class="form-control form-control js__datepicker" value="" placeholder="输入时间" id="add_time_stop">
						</div>
					</div>
					<div class="col-sm-8 pull-right text-right">
							<a class="btn btn-primary" href="{:url('index/appointment/shop_income_show')}">清空</a>
							<button class="btn btn-primary search_btn" type="submit">搜索</button>
					</div>
				</form>
			</div><!-- panel-body -->
			<div class="panel-heading">
			<?php 
				$begin_date=explode(' ', $time['begin_date']);
				$ymd=explode('-', $begin_date[0]);
				$year=$ymd[0];
				$timestamp=strtotime($time['end_date'])-1;
				$date=date("Y-m-d H:i:s",$timestamp);
				$end_date=explode(' ', $date); 
				// var_dump($year);
			?>
				<h4>{$begin_date[0]}~{$end_date[0]} 各店销售额 (总计：<font id="show_sum_money"></font>)</h4>
				<?php $get_info="";
					if(!empty($_GET['Y'])){
						$get_info.="&Y=".$_GET['Y'];
					}
					if(!empty($_GET['m'])){
						$get_info.="&m=".$_GET['m'];
					}
					if(!empty($_GET['add_time_start'])){
						$get_info.="&add_time_start=".$_GET['add_time_start'];
					}
					if(!empty($_GET['add_time_stop'])){
					$get_info.="&add_time_stop=".$_GET['add_time_stop'];
					}
					if(!empty($_GET['order'])){
					$order_info="&order=".$_GET['order'];
					}else{
					$order_info="";
					}
				?>
				<div class="text-right"><a href="{:url('Index/appointment/shop_income_show')}?excel_get=1{$get_info}{$order_info}" >下载excel</a></div>
			</div>
			<div class="panel-body">
				<div class="row">
					<form action="{:url('Index/appointment/shop_income_show')}" method="get">
					<div class="col-sm-4">
						<div class="input-group">
							<span class="input-group-addon">年</span>
							<select name="Y" class="form-control" >
								<?php for($i=2017; $i <= $year ; $i++):?>
									<option value="{$i}" <?php if($i==$_GET['Y']) echo "selected"; ?>>{$i}</option>
								<?php endfor; ?>	

							</select>
						</div>
					</div>
					<div class="col-sm-4">
						<div class="input-group">
							<span class="input-group-addon">月</span>
							<select name="m" class="form-control" >
								<option value="all">全年</option>
								<?php for($i=1; $i <13 ; $i++):?>
									<option value="{$i}"<?php if($i==$_GET['m']) echo "selected"; ?>>{$i}</option>
								<?php endfor; ?>	
							</select>
						</div>
					</div>
					<div class="col-sm-4">
					<div class="col-xs-6">
							<button class="btn btn-primary " type="submit">获取数据</button>
					</div>
					</form>
					<div class="col-xs-6">
							<a href="{:url('Index/appointment/shop_income_show')}?Y={$_GET['Y']}&m={$_GET['m']}&get_new=new" class="btn btn-warning" >刷新数据</a>
					</div>
					</div>
					
				</div><!-- row -->
				
				<table class="table table-bordered table-striped">
					<tr>
						<!-- <th>id</th> -->
						<th>店铺名称</th>
						<th>预约人数</th>
						
							
						<th class="">
							<ul class="nav ">
								<li class="dropdown">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">定金收入<span class="caret"></span></a>
									<ul class="dropdown-menu" role="menu">
										<li><a href="{:url('index/appointment/shop_income_show')}?order=bargin_income{$get_info}">顺序(小->大)</a></li>
										<li><a href="{:url('index/appointment/shop_income_show')}?order=bargin_income desc{$get_info}">倒序(大->小)</a></li>
									</ul>
								</li>
							</ul>
						</th>
						<th class="">
							<ul class="nav ">
								<li class="dropdown">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">顾客支付<span class="caret"></span></a>
									<ul class="dropdown-menu" role="menu">
										<li><a href="{:url('index/appointment/shop_income_show')}?order=guest_pay{$get_info}">顺序(小->大)</a></li>
										<li><a href="{:url('index/appointment/shop_income_show')}?order=guest_pay desc{$get_info}">倒序(大->小)</a></li>
									</ul>
								</li>
							</ul>
						</th>
						<th class="">
							<ul class="nav ">
								<li class="dropdown">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">售后金额<span class="caret"></span></a>
									<ul class="dropdown-menu" role="menu">
										<li><a href="{:url('index/appointment/shop_income_show')}?order=after_sale_income{$get_info}">顺序(小->大)</a></li>
										<li><a href="{:url('index/appointment/shop_income_show')}?order=after_sale_income desc{$get_info}">倒序(大->小)</a></li>
									</ul>
								</li>
							</ul>
						</th>
						<th class="">
							<ul class="nav ">
								<li class="dropdown">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">总额<span class="caret"></span></a>
									<ul class="dropdown-menu" role="menu">
										<li><a href="{:url('index/appointment/shop_income_show')}?order=total{$get_info}">顺序(小->大)</a></li>
										<li><a href="{:url('index/appointment/shop_income_show')}?order=total desc{$get_info}">倒序(大->小)</a></li>
									</ul>
								</li>
							</ul>
						</th>
						<th>平均（总/预约）</th>
						<th>上次数据更新</th>
					</tr>
					<?php $sum=0; foreach ($income as $v) :?>
					<tr>
					<!-- <td>{$v['id']}</td> -->
						<td>{$v['shopname']}</td>
						<td>{$v['guest_num']}</td>
						<td><a href="{:url('index/appointment/bargin_income_show')}?begin_date={$time['begin_date']}&end_date={$time['end_date']}&id={$v['id']}&money={$v['bargin_income']}">{$v['bargin_income']}</a></td>
						<td><a href="{:url('index/appointment/guest_pay_show')}?begin_date={$time['begin_date']}&end_date={$time['end_date']}&id={$v['id']}&money={$v['guest_pay']}">{$v['guest_pay']}</a></td>
						<td><a href="{:url('index/appointment/after_sale_income_show')}?begin_date={$time['begin_date']}&end_date={$time['end_date']}&id={$v['id']}&money={$v['after_sale_income']}">{$v['after_sale_income']}</a></td>
						<?php $sum+=$v['total'];?>
						<td>{$v['total']}</td>
						<?php 
						if(empty($v['guest_num'])){
							$ave=0;
						}else{
							$ave=$v['total']/$v['guest_num'];
							// $ave=floor($ave*100)/100;
							$ave=round($ave,2);
						} ?>
						<td>{$ave}</td>
						<td>{$v['time']}</td>

					</tr>
					<?php endforeach; ?>
				</table>
			</div>
			
		</div>
	</div><!-- container	 -->


<input type="hidden" value='{$sum}' id="sum_money">


<input type="hidden" value='<?php if(!empty($_POST['add_time_start'])){ echo $_POST['add_time_start'];} ?>' id="add_time_start_hid">
<input type="hidden" value='<?php if(!empty($_POST['add_time_stop'])){ echo $_POST['add_time_stop'];} ?>' id="add_time_stop_hid">
<script>
	$('#show_sum_money').text($('#sum_money').val());

	//添加开始时间
	add_start_time=$('#add_time_start_hid').val();
	$('#add_time_start').val(add_start_time);
	add_time_stop=$('#add_time_stop_hid').val();
	$('#add_time_stop').val(add_time_stop);
	$('#appointment_time_start').val($('#appointment_time_start_hid').val());
	$('#appointment_time_stop').val($('#appointment_time_stop_hid').val());


	$('#collapseSearch').collapse('hode');

	$('.panel-title').click(function(){
		val=$(this).attr('href');
		// alert(val);
		$('.collapse').collapse('hide');
		$('#accordionControl').collapse('hide');
		$(val).collapse();
	});
		// $('.collapse').collapse('toggle');


function my_confirm(num){
	if(num==1){
		return confirm("确定删除？");
	}
	if(num==2){
		return confirm("确定到达？");
	}
}

</script>

	<!-- date专用 -->
	<script src="/public/date/lib/picker.js"></script>
    <script src="/public/date/lib/picker.date.js"></script>
    <script src="/public/date/lib/picker.time.js"></script>
    <script src="/public/date/demo/scripts/main.js"></script>
	<!-- date专用 -->

</body>
</html>

